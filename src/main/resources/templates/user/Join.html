<!DOCTYPE html>
<html lang="UTF-8" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Join</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .form-group label {
            font-weight: bold;
        }
    </style>

    <!-- jquery cdn -->
    <script
            src="https://code.jquery.com/jquery-3.6.3.min.js"
            integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU="
            crossorigin="anonymous">
    </script>
</head>
<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-body">
                    <h4 class="card-title text-center mb-4">회원가입</h4>
                    <form id="IdPwCheck" onsubmit="submitChk()" action="/Login" method="post">
                        <div class="form-group mb-3">
                            <label for="email">이메일</label>
                            <input type="id" class="form-control" id="email" name="email" tabindex="1" onblur="emailCheck()">
                            <span id="check-result"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label for="password">비밀번호</label>
                            <input type="password" class="form-control" id="password" name="password" tabindex="2"> <!--required-->
                            <span id="passwordCheck"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label for="pwchk">비밀번호 확인</label>
                            <input type="password" class="form-control" id="pwchk" name="pwchk" tabindex="3"> <!--required-->
                            <span id="pwCheck"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label for="name">이름</label>
                            <input type="text" class="form-control" id="name" name="name" tabindex="4"> <!--required-->
                        </div>
                        <div class="form-group mb-3">
                            <label for="phone">전화번호</label>
                            <input type="text" class="form-control" id="phone" name="phone" tabindex="5"> <!--required-->
                        </div>

                        <!--                    관리자 회원가입 후 유저들이 선택 못하게 주석처리 함 -->
                        <!--                        <div>
                                                    <input type="radio" name="role" value="User">유저
                                                    <input type="radio" name="role" value="Admin">관리자
                                                </div> -->

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">회원가입</button>
                            <a href="/Login" class="btn btn-secondary">로그인</a>
                            <a href="/index" class="btn btn-info">홈으로</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script th:inline="javascript">
// 이메일 중복 체크 함수
async function emailCheck() {
    const email = $("#email").val();
    const checkResult = $("#check-result");
    const passwordCheck = $("#passwordCheck");
    const pwCheck = $("#pwCheck");
    console.log("입력 값 : ", email);

    // 이메일이 공백일 경우
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/; // 정규식 패턴 사용
    if (!emailRegex.test(email)) {
      checkResult.css("color", "red").text("이메일 형식이 유효하지 않습니다.");
      return;
    }

    try {
      const res = await
      $.ajax({
        // 요청방식: post, url: "email-check", 데이터: 이메일
        type: "post",
        url: "/User/email-check",
        data: { email },
      });
      console.log("요청 성공", res);
      if (res === "ok") {
        console.log("사용 가능한 이메일");
        checkResult.css("color", "green").text("사용 가능한 이메일");
      } else {
        console.log("이미 사용 중인 이메일");
        checkResult.css("color", "red").text("이미 사용 중인 이메일");
      }
    } catch (err) {
      console.log("에러발생", err);
    }
  }

// 회원가입 버튼 클릭 시 함수
function submitChk() {
    const email = $("#email").val();
    const password = $("#password").val();
    const pwchk = $("#pwchk").val();
    const checkResult = $("#check-result");
    const passwordCheck = $("#passwordCheck");
    const pwCheck = $("#pwCheck");


    // 이메일 중복 체크
    if (checkResult.text() !== "사용 가능한 이메일") {
      $("#email-check-msg").text("이메일 중복을 확인해주세요.").show();
      $("#email").select();
      return false;
    } else {
      $("#email-check-msg").hide(); // 경고 메시지 숨기기
      }

      // 비밀번호 확인
      if (password === "") {
      passwordCheck.css("color", "red").text("비밀번호를 입력해주세요");
      //  alert("비밀번호를 입력해주세요.");
        $("#password").select();
        return false;
      } else if (password !== pwchk) {
      pwCheck.css("color", "red").text("비밀번호가 틀렸습니다");
      //  alert("비밀번호가 일치하지 않습니다.");
        $("#pwchk").select();
        return false;
      } else {
        // 모든 조건을 만족하면 form 제출
        return true;
        }
      }
  $(document).ready(function() {
    // 이메일 blur 시 이메일 중복 체크 실행
    $("#email").blur(function() {
      $("#password").focus();
    });

    // 회원가입 버튼 클릭 시 submitChk 함수 실행
    $("form").submit(function() {
      return submitChk();
    });
  });
</script>
</html>